title: CVE-2017-9772の脆弱性
date: 2017-06-25
tags: ocaml


OCaml4.04.0,4.04.1にローカル権限昇格の脆弱性があったので4.04.2が出てます。

[0007557: local privilege escalation issue with ocaml binaries](https://caml.inria.fr/mantis/view.php?id=7557)

影響を受けるのは、以下の状況ですが、かなり限定的だと思います。詳しくは上のmantisの方に再現手順があります。

1. setuidされたocamlコンパイラで生成された実行ファイルに対し
1. `CAML_CPLUGINS, CAML_NATIVE_CPLUGINS, CAML_BYTE_CPLUGINS`環境変数に細工された共有ライブラリへのパスを設定された場合

脆弱性が埋め込まれた経緯は、

* 4.04.0からocamlランタイムに`CAML_CPLUGINS`環境変数に設定された共有ライブラリを自動でロードする機能が追加されたが([プルリク](https://github.com/ocaml/ocaml/pull/668))、
ドキュメント化されずデフォルトで有効な状態だった。
* 環境変数の読み込み時に、[secure\_getenv](https://linuxjm.osdn.jp/html/LDP_man-pages/man3/getenv.3.html)のようなset-user-IDチェックが存在しなかったため、
素通ししてしまった。

対策として、`secure_getenv`がある場合は使用して、なければ自前でチェックするようにしたようです。

`Sys.getenv`と`Unix.getenv`も変更の影響を受けるので、以前の動作が欲しい場合は`Sys.unsafe_getenv` が使用できます。

また、ocamlコンパイラ自体のビルド時に`-no-cplugins`フラグを指定するとこの機能自体を無効化できます。
対策でuidはチェックされるようになりましたが、
実行時に環境変数に指定されたファイルが自動ロードされてランタイムを変更できてしまう、
というのはどうも筋が良くない気がします。無効化しておいたほうが無難な印象です。
